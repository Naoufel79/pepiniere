{% extends 'store_base.html' %}
{% load static %}

{% block title %}المنتجات - مزرعة نوادر التين{% endblock %}

{% block content %}
<section class="section">
  <div class="hero">
    <div>
      <h1>منتجات موسمية بجودة عالية</h1>
      <p>تصفح المنتجات وأضف ما تريد إلى السلة، ثم أكمل الطلب في دقائق.</p>
      <div class="hero-actions">
        <a class="btn btn-primary" href="#catalog">عرض المنتجات</a>
        <a class="btn btn-ghost" href="{% url 'public_order' %}">إتمام الطلب</a>
      </div>
    </div>
    <div class="panel">
      <div class="panel-title">لماذا نحن؟</div>
      <div style="color: var(--muted); line-height: 1.8;">
        <div>• دفع عند الاستلام (حسب المتاح)</div>
        <div>• تأكيد سريع عبر الهاتف</div>
        <div>• توصيل داخل تونس</div>
      </div>
    </div>
  </div>

  <div class="toolbar" id="catalog">
    <div class="toolbar-row">
      <input class="input" id="searchInput" type="search" placeholder="ابحث عن منتج..." aria-label="بحث" />
      <select id="sortSelect" aria-label="ترتيب">
        <option value="name">ترتيب: الاسم</option>
        <option value="price_asc">السعر: من الأقل للأعلى</option>
        <option value="price_desc">السعر: من الأعلى للأقل</option>
      </select>
      <label style="display:flex;align-items:center;gap:10px;">
        <input id="inStockOnly" type="checkbox" />
        متوفر فقط
      </label>
      <button class="btn btn-ghost" type="button" id="clearFilters">مسح</button>
    </div>
  </div>
</section>

<section class="section">
  <h2 class="section-title">المنتجات</h2>
  <p class="section-subtitle">اضغط على المنتج لعرض التفاصيل أو أضفه مباشرة إلى السلة.</p>

  {% if produits %}
  <div class="grid products-grid" id="productsGrid">
    {% for produit in produits %}
    <article
      class="card product-card"
      data-id="{{ produit.id }}"
      data-name="{{ produit.nom|escape }}"
      data-price="{{ produit.prix_vente }}"
      data-stock="{{ produit.quantite }}"
    >
      <a href="{% url 'product_detail' produit.id %}" style="color:inherit;text-decoration:none;">
        <div class="product-media">
          {% if produit.image %}
            <img data-skeleton src="{{ produit.image.url }}" alt="{{ produit.nom|escape }}" loading="lazy" decoding="async" />
          {% else %}
            <div style="height:100%;display:flex;align-items:center;justify-content:center;color:rgba(229,231,235,.55);">لا توجد صورة</div>
          {% endif %}
        </div>
      </a>
      <div class="card-body">
        <h3 class="product-title">{{ produit.nom }}</h3>
        <div class="product-meta">
          <div class="price">{{ produit.prix_vente }} د.ت</div>
          {% if produit.quantite > 0 %}
            <div class="status ok">متوفر</div>
          {% else %}
            <div class="status no">غير متوفر</div>
          {% endif %}
        </div>
        <p class="product-desc">{% if produit.description %}{{ produit.description }}{% else %}وصف غير متوفر.{% endif %}</p>

        <div class="card-actions">
          <a class="btn btn-ghost" href="{% url 'product_detail' produit.id %}">التفاصيل</a>
          <button
            class="btn btn-primary"
            type="button"
            {% if produit.quantite <= 0 %}disabled{% endif %}
            onclick="window.storeAddToCart({ id: '{{ produit.id }}', name: '{{ produit.nom|escapejs }}', price: '{{ produit.prix_vente }}', imageUrl: '{% if produit.image %}{{ produit.image.url }}{% endif %}' })"
          >
            أضف للسلة
          </button>
        </div>
      </div>
    </article>
    {% endfor %}
  </div>
  {% else %}
    <div class="panel">لا توجد منتجات حالياً.</div>
  {% endif %}
</section>
{% endblock %}

{% block extra_scripts %}
<script>
  (function(){
    const grid = document.getElementById('productsGrid');
    if(!grid) return;

    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const inStockOnly = document.getElementById('inStockOnly');
    const clearBtn = document.getElementById('clearFilters');

    const cards = Array.from(grid.querySelectorAll('[data-id]'));

    function apply(){
      const q = (searchInput?.value || '').trim().toLowerCase();
      const sort = sortSelect?.value || 'name';
      const stockOnly = Boolean(inStockOnly?.checked);

      let filtered = cards.filter((c) => {
        const name = (c.dataset.name || '').toLowerCase();
        const stock = parseInt(c.dataset.stock || '0', 10) || 0;
        if (q && !name.includes(q)) return false;
        if (stockOnly && stock <= 0) return false;
        return true;
      });

      filtered.sort((a,b) => {
        const an = (a.dataset.name || '');
        const bn = (b.dataset.name || '');
        const ap = parseFloat(a.dataset.price || '0') || 0;
        const bp = parseFloat(b.dataset.price || '0') || 0;

        if (sort === 'price_asc') return ap - bp;
        if (sort === 'price_desc') return bp - ap;
        return an.localeCompare(bn, 'ar');
      });

      // Rebuild DOM (cheap enough for small catalog)
      grid.innerHTML = '';
      filtered.forEach((c) => grid.appendChild(c));
    }

    searchInput?.addEventListener('input', apply);
    sortSelect?.addEventListener('change', apply);
    inStockOnly?.addEventListener('change', apply);
    clearBtn?.addEventListener('click', () => {
      if (searchInput) searchInput.value = '';
      if (sortSelect) sortSelect.value = 'name';
      if (inStockOnly) inStockOnly.checked = false;
      apply();
    });

    apply();
  })();
</script>
{% endblock %}
