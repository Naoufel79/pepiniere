{% extends 'store_base.html' %}
{% load static %}

{% block title %}إتمام الطلب - مزرعة نوادر التين{% endblock %}

{% block content %}
<section class="section">
  <h1 class="section-title">إتمام الطلب</h1>
  <p class="section-subtitle">خطوات بسيطة: تأكيد الهاتف → معلومات التوصيل → تأكيد المنتجات.</p>

  <div class="stepper" aria-label="خطوات إتمام الطلب">
    <div class="step is-active" id="step1">1) تأكيد الهاتف</div>
    <div class="step" id="step2">2) معلومات التوصيل</div>
    <div class="step" id="step3">3) تأكيد الطلب</div>
  </div>

  <div class="checkout-grid" style="margin-top:14px">
    <div class="checkout-main">
      <form method="POST" id="orderForm" class="panel">
        {% csrf_token %}
        <input type="hidden" id="firebase_id_token" name="firebase_id_token" />

                <!-- Step 1: Verification -->
        {% if phone_verification_mode == 'static_code' %}
          <div class="panel" style="background:rgba(255,255,255,.03)">
            <div class="panel-title">تأكيد الطلب عبر رمز</div>
            <div id="manualCodeStatus" class="alert" style="display:none;"></div>

            <div class="form-grid">
              <div class="field">
                <label for="manualCode">الرمز</label>
                <input class="input" type="text" id="manualCode" name="manual_verification_code" inputmode="numeric" autocomplete="one-time-code" placeholder="20707272" required />
              </div>

              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button type="button" id="verifyManualCodeBtn" class="btn btn-primary">تأكيد الرمز</button>
              </div>

              <div style="color:var(--muted);line-height:1.6">أدخل الرمز الذي أعطيناه لك ثم اضغط “تأكيد الرمز”.</div>

              <div id="manualCodeError" class="alert alert-danger" style="display:none;"></div>
              <div id="manualCodeSuccess" class="alert alert-success" style="display:none;"></div>
            </div>
          </div>
        {% else %}
          <div class="panel" style="background:rgba(255,255,255,.03)" id="phoneAuthCard">
            <div class="panel-title">تأكيد رقم الهاتف عبر SMS</div>

            <div class="form-grid">
              <div class="field">
                <label for="telephone">رقم الهاتف <span style="color:var(--danger)">*</span></label>
                <input class="input" type="tel" id="telephone" name="telephone" required placeholder="+21620123456" inputmode="tel" autocomplete="tel" />
                <div style="color:var(--muted);line-height:1.6">اكتب رقمك بصيغة دولية (مثال: +21620123456). يمكن أيضاً إدخال 8 أرقام وسيتم تحويلها تلقائياً إلى +216.</div>
              </div>

              <div id="recaptcha-container"></div>

              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button type="button" id="sendOtpBtn" class="btn btn-primary">إرسال الرمز</button>
              </div>

              <div id="verifySection" style="display:none;">
                <div class="field">
                  <label for="otpCode">رمز التحقق (6 أرقام)</label>
                  <input class="input" type="text" id="otpCode" maxlength="6" inputmode="numeric" autocomplete="one-time-code" placeholder="123456" />
                </div>
                <div style="display:flex;gap:10px;flex-wrap:wrap">
                  <button type="button" id="verifyOtpBtn" class="btn btn-primary">تأكيد الرمز</button>
                </div>
              </div>

              <div id="phoneAuthStatus" class="alert" style="display:none;"></div>
              <div id="phoneAuthError" class="alert alert-danger" style="display:none;"></div>
              <div id="phoneAuthSuccess" class="alert alert-success" style="display:none;"></div>
            </div>
          </div>
        {% endif %}

<!-- Step 2: Delivery -->
        <div class="panel" style="margin-top:14px;background:rgba(255,255,255,.03)">
          <div class="panel-title">معلومات التوصيل</div>
          <div class="form-grid">
            <div class="field">
              <label for="nom">الاسم <span style="color:var(--danger)">*</span></label>
              <input class="input" type="text" id="nom" name="nom" required />
            </div>
            {% if phone_verification_mode == 'static_code' %}
            <div class="field">
              <label for="telephone">رقم الهاتف <span style="color:var(--danger)">*</span></label>
              <input class="input" type="tel" id="telephone" name="telephone" required placeholder="+21620123456" inputmode="tel" autocomplete="tel" />
              <div style="color:var(--muted);line-height:1.6">اكتب رقمك بصيغة دولية (مثال: +21620123456). يمكن أيضاً إدخال 8 أرقام وسيتم تحويلها تلقائياً إلى +216.</div>
            </div>
            {% endif %}
            <div class="field">
              <label for="wilaya">الولاية <span style="color:var(--danger)">*</span></label>
              <select class="input" id="wilaya" name="wilaya" required>
                <option value="">اختر الولاية</option>
                <option value="تونس">تونس</option>
                <option value="أريانة">أريانة</option>
                <option value="بن عروس">بن عروس</option>
                <option value="منوبة">منوبة</option>
                <option value="نابل">نابل</option>
                <option value="زغوان">زغوان</option>
                <option value="بنزرت">بنزرت</option>
                <option value="باجة">باجة</option>
                <option value="جندوبة">جندوبة</option>
                <option value="الكاف">الكاف</option>
                <option value="سليانة">سليانة</option>
                <option value="سوسة">سوسة</option>
                <option value="المنستير">المنستير</option>
                <option value="المهدية">المهدية</option>
                <option value="صفاقس">صفاقس</option>
                <option value="القيروان">القيروان</option>
                <option value="القصرين">القصرين</option>
                <option value="سيدي بوزيد">سيدي بوزيد</option>
                <option value="قابس">قابس</option>
                <option value="مدنين">مدنين</option>
                <option value="تطاوين">تطاوين</option>
                <option value="قفصة">قفصة</option>
                <option value="توزر">توزر</option>
                <option value="قبلي">قبلي</option>
              </select>
            </div>

            <div class="field">
              <label for="ville">المدينة <span style="color:var(--danger)">*</span></label>
              <input class="input" type="text" id="ville" name="ville" required />
            </div>

            <div class="field">
              <label for="email">البريد الإلكتروني (اختياري)</label>
              <input class="input" type="email" id="email" name="email" placeholder="example@email.com" />
            </div>
          </div>
        </div>

        <!-- Step 3: Products -->
        <div class="panel" style="margin-top:14px;background:rgba(255,255,255,.03)" id="catalog">
          <div class="panel-title">المنتجات</div>
          <div class="grid" style="gap:12px">
            {% for produit in produits %}
              <div class="card" style="padding:12px">
                <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
                  <div style="display:flex;gap:12px;align-items:center;min-width:220px">
                    {% if produit.image %}
                      <img src="{{ produit.image.url }}" alt="" width="56" height="56" style="border-radius:12px;object-fit:cover" loading="lazy" decoding="async" />
                    {% endif %}
                    <div>
                      <div style="font-weight:950">{{ produit.nom }}</div>
                      <div style="color:rgba(229,231,235,.70)">{{ produit.prix_vente }} د.ت</div>
                      {% if produit.quantite > 0 %}
                        <div class="status ok" style="margin-top:6px">متوفر ({{ produit.quantite }})</div>
                      {% else %}
                        <div class="status no" style="margin-top:6px">غير متوفر</div>
                      {% endif %}
                    </div>
                  </div>

                  {% if produit.quantite > 0 %}
                    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                      <label for="product_{{ produit.id }}">الكمية</label>
                      <input
                        class="input qty-input product-quantity"
                        type="number"
                        id="product_{{ produit.id }}"
                        name="product_{{ produit.id }}"
                        min="0"
                        max="{{ produit.quantite }}"
                        value=""
                        data-product-name="{{ produit.nom|escape }}"
                        data-product-price="{{ produit.prix_vente }}"
                      />
                      <button class="btn btn-ghost" type="button"
                        onclick="window.storeAddToCart({ id: '{{ produit.id }}', name: '{{ produit.nom|escapejs }}', price: '{{ produit.prix_vente }}', imageUrl: '{% if produit.image %}{{ produit.image.url }}{% endif %}' }); window.scrollTo({top:0, behavior:'smooth'});">
                        + للسلة
                      </button>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>

        <button type="submit" id="placeOrderBtn" class="btn btn-primary" style="width:100%;margin-top:14px" disabled>
          تأكيد الطلب
        </button>
      </form>
    </div>

    <aside class="checkout-aside">
      <div class="panel">
        <div class="panel-title">ملخص الطلب</div>
        <div id="orderSummary" style="display:none;">
          <div id="summaryItems" class="grid" style="gap:10px"></div>
          <div style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;gap:12px">
            <div style="color:var(--muted)">الإجمالي</div>
            <div id="totalAmount" style="font-size:22px;font-weight:950">0.00 د.ت</div>
          </div>
        </div>
        <div id="summaryEmpty" style="color:var(--muted);line-height:1.7">اختر المنتجات لتظهر هنا.</div>

        <div style="margin-top:14px">
          <a class="btn btn-ghost" href="{% url 'cart' %}">عرض السلة</a>
        </div>
      </div>
    </aside>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
  const ORDER_STORAGE_KEY = 'pendingOrder';

  function saveOrderToStorage() {
    const orderData = {
      nom: document.getElementById('nom')?.value || '',
      wilaya: document.getElementById('wilaya')?.value || '',
      ville: document.getElementById('ville')?.value || '',
      telephone: document.getElementById('telephone')?.value || '',
      email: document.getElementById('email')?.value || '',
      products: {},
      cartItems: []
    };

    const quantities = document.querySelectorAll('.product-quantity');
    quantities.forEach((input) => {
      const qty = parseInt(input.value, 10) || 0;
      if (qty > 0) orderData.products[input.id] = qty;
    });

    localStorage.setItem(ORDER_STORAGE_KEY, JSON.stringify(orderData));
  }

  function loadOrderFromStorage() {
    try {
      const raw = localStorage.getItem(ORDER_STORAGE_KEY);
      if (!raw) return;
      const data = JSON.parse(raw);

      if (data.nom) document.getElementById('nom').value = data.nom;
      if (data.wilaya) document.getElementById('wilaya').value = data.wilaya;
      if (data.ville) document.getElementById('ville').value = data.ville;
      if (data.telephone && document.getElementById('telephone')) document.getElementById('telephone').value = data.telephone;
      if (data.email) document.getElementById('email').value = data.email;

      const products = data.products || {};
      Object.keys(products).forEach((id) => {
        const input = document.getElementById(id);
        if (input) input.value = products[id];
      });
    } catch (e) {
      console.error(e);
    }
  }

  function updateOrderSummary() {
    const summary = document.getElementById('orderSummary');
    const empty = document.getElementById('summaryEmpty');
    const list = document.getElementById('summaryItems');
    const totalEl = document.getElementById('totalAmount');

    const quantities = document.querySelectorAll('.product-quantity');
    let total = 0;
    const items = [];

    quantities.forEach((input) => {
      const qty = parseInt(input.value, 10) || 0;
      if (qty <= 0) return;

      const name = input.getAttribute('data-product-name') || '';
      const price = parseFloat(input.getAttribute('data-product-price') || '0') || 0;
      total += qty * price;
      items.push({ name, qty, price });
    });

    if (!items.length) {
      summary.style.display = 'none';
      empty.style.display = 'block';
      list.innerHTML = '';
      totalEl.textContent = '0.00 د.ت';
      saveOrderToStorage();
      return;
    }

    empty.style.display = 'none';
    summary.style.display = 'block';
    list.innerHTML = '';

    items.forEach((it) => {
      const row = document.createElement('div');
      row.className = 'card';
      row.style.padding = '10px';
      row.innerHTML = `<div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap">
        <div style="font-weight:900">${it.name}</div>
        <div style="color:rgba(229,231,235,.70)">${it.qty} × ${it.price.toFixed(2)}</div>
      </div>`;
      list.appendChild(row);
    });

    totalEl.textContent = `${total.toFixed(2)} د.ت`;
    saveOrderToStorage();
  }

  function initCheckout() {
    loadOrderFromStorage();

    document.querySelectorAll('.product-quantity').forEach((input) => {
      input.addEventListener('input', updateOrderSummary);
      input.addEventListener('change', updateOrderSummary);
    });

    ['nom','wilaya','ville','telephone','email'].forEach((id) => {
      const el = document.getElementById(id);
      el?.addEventListener('input', saveOrderToStorage);
      el?.addEventListener('change', saveOrderToStorage);
    });

    updateOrderSummary();
  }

  document.addEventListener('DOMContentLoaded', initCheckout);
</script>

{% if phone_verification_mode == 'static_code' %}
<script type="module" src="{% static 'js/order_manual_code.js' %}"></script>
{% else %}
<script type="module" src="{% static 'js/order_phone_otp.js' %}"></script>
{% endif %}
{% endblock %}
